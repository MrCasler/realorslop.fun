{% extends 'base.html' %}

{% block title %}Home - Real or Slop{% endblock %}


{% block content %}

<!--<pre>{{ game_data }}</pre> -->

<section class="" id="gameloop">
    <div class="container mx-auto px-4">

    <h4 id="gameloop-subheading" class="text-2xl text-center" > Guess which image is real</h4>

    <div class="container mx-auto px-4 text-center">
        
        <p> if you get it wrong, the game will explain why it is AI-generated.</p>
    </div>

<div 
  x-data='{
    leftImage: {{ game_data.left_image | tojson }},
    rightImage: {{ game_data.right_image | tojson }},
    isLeftReal: {{ game_data.is_left_real | tojson }},
    explanation: {{ game_data.explanation | tojson }},
    source: {{ game_data.source | tojson }},
    score: 0, lives: 3, feedback: "", locked: false,
    selectedTag: "all",
    tags: ["all", "faces", "cities"],
    showPlayAgain: false,

    async init() {
        try {
            const res = await fetch("/api/tags");
            const data = await res.json();
            this.tags = ["all", ...data.tags];
            // restore last chosen tag if you like:
            const saved = localStorage.getItem("ros_tag");
            umami?.track("game_start", { tag: this.selectedTag });

            if (saved && this.tags.includes(saved)) this.selectedTag = saved;
            } 
        catch (e) 
            { 
                console.warn("tags fetch failed", e); 
            }
    },

    async nextRound() {
      if (this.lives <= 0) {
        this.feedback = `ðŸ’€ Game Over! Final score: ${this.score}`;
        return;
      }
      try {
        const response = await fetch(`/api/next?tag=${encodeURIComponent(this.selectedTag)}`);
        const data = await response.json();
        
        if (data.error === "not_enough_images_for_tag") {
        this.feedback = "Not enough images in this category yet. Switching to All.";
        this.selectedTag = "all";
        return this.nextRound();
        }

        this.leftImage = data.left_image;
        this.rightImage = data.right_image;
        this.isLeftReal = data.is_left_real;
        this.explanation = data.explanation;
        this.feedback = "";

      } catch (error) {
        console.error("Error fetching next round data:", error);
      } finally {
        this.locked = false;
      }
    },

    playAgain() {
  this.score = 0;
  this.lives = 3;
  this.feedback = "";
  this.showPlayAgain = false;
  umami?.track("game_restart", { tag: this.selectedTag });
  this.nextRound();
},

shareScore() {
  const tweet = `I scored ${this.score} correct guesses on realorslop.fun ðŸŽ¨ðŸ¤–, try beating my score`;
  umami?.track("share_score", { score: this.score, tag: this.selectedTag });
  window.open(`https://x.com/intent/tweet?text=${encodeURIComponent(tweet)}`);
},  

    async guess(side) {
    if (this.locked) return;
      const correct = (side === "left" && this.isLeftReal) || (side === "right" && !this.isLeftReal);
      if (correct) {
        this.score++;
        this.feedback = "âœ… Correct! Great Job! ðŸ˜Š I got the image from " + this.source;
        umami?.track("guess_correct", { tag: this.selectedTag });

      } else {
        this.lives--; this.lives = Math.max(this.lives, 0);
        this.feedback = "âŒ Wrong! "     + this.explanation;
        umami?.track("guess_wrong", { tag: this.selectedTag });

      }

      if (this.lives <= 0) {
        this.feedback = `ðŸ’€ Game Over! Final score: ${this.score}`;
        this.showPlayAgain = true;
        umami?.track("game_over", { score: this.score, tag: this.selectedTag });
        
        return;
      }
        this.locked = true;
        setTimeout(() => this.nextRound(), 700);
    }

  }'
  class="container mx-auto px-4"
>

        <div class="mb-4 ">

            <p class="text-lg font-semibold text-center">Score: <span x-text="score"></span></p>
            <p class="text-lg font-semibold text-center">Lives: <span x-text="lives"></span></p>
            <div x-show="feedback" class="mt-3 px-4 py-2 rounded text-white" :class="feedback.includes('âœ…') ? 'bg-green-500' : 'bg-red-500'">
                <p x-text="feedback"></p>
            </div>            
                <div x-show="showPlayAgain" class="mt-4">
                <button @click="playAgain()" class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600">
                    Play Again
                </button>
                <button @click="shareScore()" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600"> 
                    Share your score
                </button>
            </div>
        </div>
        <select x-model="selectedTag" @change="localStorage.setItem('ros_tag', selectedTag); nextRound()" class="border rounded p-1 flex">
            <template x-for="tag in tags" :key="tag">
                <option :value="tag" x-text="tag.charAt(0).toUpperCase() + tag.slice(1)"></option>
            </template>
        </select>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 items-stretch">
            <div class="rounded overflow-hidden bg-gray-50">
                <img :src="leftImage" @click="guess('left')" alt="Left Image" class="" loading="lazy">
            </div>
            <div class="rounded overflow-hidden bg-gray-50">
                <img :src="rightImage" @click="guess('right')" alt="Right Image" class="" loading="lazy">
            </div>
        </div>
    </div>
</section>
{% endblock %}
